
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Havsnavigering</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#000020" />
  <base href="./">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #000020;
    }
    #infoBox {
      position: absolute;
      top: 80px;
      left: 10px;
      background: rgba(0, 0, 30, 0.8);
      color: #00ffff;
      padding: 10px 15px;
      border-radius: 12px;
      font-size: 1.1em;
      box-shadow: 0 0 10px #00ffff55;
      z-index: 1000;
    }
    #compassContainer {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 80px;
      height: 80px;
      z-index: 1001;
    }
    #compassSVG {
      width: 100%;
      height: 100%;
    }
    #needle {
      transform-origin: 50% 50%;
      transition: transform 0.3s ease-out;
    }
  
    #controls {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,30,0.8);
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 0 10px #00ffff55;
      z-index: 1000;
    }
    button {
      background-color: #002244;
      color: #00ffff;
      border: 1px solid #00ffff88;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      margin-bottom: 5px;
      display: block;
    }
    #waypoints button {
      width: 100%;
    }
    
</head>
<body>
  <div id="map"></div>
  <div id="infoBox">Avstånd: –<br>Riktning: –</div>
  <div id="compassContainer">
    <svg id="compassSVG" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <circle cx="50" cy="50" r="48" stroke="#00ffff" stroke-width="2" fill="rgba(0,0,0,0.5)" />
      <text x="50" y="15" text-anchor="middle" fill="#00ffff" font-size="10">N</text>
      <text x="50" y="95" text-anchor="middle" fill="#00ffff" font-size="10">S</text>
      <text x="85" y="54" text-anchor="middle" fill="#00ffff" font-size="10">E</text>
      <text x="15" y="54" text-anchor="middle" fill="#00ffff" font-size="10">W</text>
      <polygon id="needle" points="50,20 45,55 50,50 55,55" fill="red" />
    </svg>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js">
    function saveWaypoint() {
      if (!destMarker) return;
      const name = prompt("Namnge platsen:");
      if (!name) return;
      const pos = destMarker.getLatLng();
      const saved = JSON.parse(localStorage.getItem("waypoints") || "[]");
      saved.push({ name, lat: pos.lat, lng: pos.lng });
      localStorage.setItem("waypoints", JSON.stringify(saved));
      renderWaypoints();
    }

    function renderWaypoints() {
      const container = document.getElementById("waypoints");
      container.innerHTML = "";
      const saved = JSON.parse(localStorage.getItem("waypoints") || "[]");
      saved.forEach(wp => {
        const btn = document.createElement("button");
        btn.textContent = wp.name;
        btn.onclick = () => {
          const latlng = L.latLng(wp.lat, wp.lng);
          if (destMarker) map.removeLayer(destMarker);
          destMarker = L.marker(latlng, { draggable: true }).addTo(map).bindPopup("Mål").openPopup();
          updatePosition({ coords: userMarker.getLatLng() });
        };
        container.appendChild(btn);
      });
    }

    renderWaypoints();
  </script>

  <script>
    const map = L.map('map').setView([57.7, 11.9], 10);
    const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    });
    const seaLayer = L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenSeaMap'
    });
    baseLayer.addTo(map);
    seaLayer.addTo(map);

    let userMarker = null;
    let destMarker = null;
    let navLine = null;

    function toRadians(deg) { return deg * Math.PI / 180; }
    function toDegrees(rad) { return rad * 180 / Math.PI; }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = toRadians(lat1), φ2 = toRadians(lat2);
      const Δφ = toRadians(lat2 - lat1);
      const Δλ = toRadians(lon2 - lon1);
      const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return (R * c) / 1852;
    }

    function calculateBearing(lat1, lon1, lat2, lon2) {
      const φ1 = toRadians(lat1), φ2 = toRadians(lat2);
      const Δλ = toRadians(lon2 - lon1);
      const y = Math.sin(Δλ) * Math.cos(φ2);
      const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
      const θ = Math.atan2(y, x);
      return (toDegrees(θ) + 360) % 360;
    }

    function updateInfoBox(dist, bearing) {
      document.getElementById("infoBox").innerHTML = `Avstånd: ${dist.toFixed(2)} NM<br>Riktning: ${bearing.toFixed(0)}°`;
      document.getElementById("needle").setAttribute("transform", `rotate(${bearing},50,50)`);
    }

    function updatePosition(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      if (!userMarker) {
        userMarker = L.marker([lat, lng]).addTo(map).bindPopup("Din position").openPopup();
      } else {
        userMarker.setLatLng([lat, lng]);
      }

      if (destMarker) {
        const dest = destMarker.getLatLng();
        if (navLine) map.removeLayer(navLine);
        navLine = L.polyline([[lat, lng], [dest.lat, dest.lng]], { color: 'cyan' }).addTo(map);
        const dist = calculateDistance(lat, lng, dest.lat, dest.lng);
        const bearing = calculateBearing(lat, lng, dest.lat, dest.lng);
        updateInfoBox(dist, bearing);
      }
    }

    navigator.geolocation.watchPosition(updatePosition, console.error, {
      enableHighAccuracy: true,
      maximumAge: 1000
    });

    map.on('click', function (e) {
      if (destMarker) map.removeLayer(destMarker);
      destMarker = L.marker(e.latlng, { draggable: true }).addTo(map).bindPopup("Mål").openPopup();
      destMarker.on("drag", () => updatePosition({ coords: userMarker.getLatLng() }));
    });
  
    function saveWaypoint() {
      if (!destMarker) return;
      const name = prompt("Namnge platsen:");
      if (!name) return;
      const pos = destMarker.getLatLng();
      const saved = JSON.parse(localStorage.getItem("waypoints") || "[]");
      saved.push({ name, lat: pos.lat, lng: pos.lng });
      localStorage.setItem("waypoints", JSON.stringify(saved));
      renderWaypoints();
    }

    function renderWaypoints() {
      const container = document.getElementById("waypoints");
      container.innerHTML = "";
      const saved = JSON.parse(localStorage.getItem("waypoints") || "[]");
      saved.forEach(wp => {
        const btn = document.createElement("button");
        btn.textContent = wp.name;
        btn.onclick = () => {
          const latlng = L.latLng(wp.lat, wp.lng);
          if (destMarker) map.removeLayer(destMarker);
          destMarker = L.marker(latlng, { draggable: true }).addTo(map).bindPopup("Mål").openPopup();
          updatePosition({ coords: userMarker.getLatLng() });
        };
        container.appendChild(btn);
      });
    }

    renderWaypoints();
  </script>

</body>
</html>
