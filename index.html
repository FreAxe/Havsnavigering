<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Båtrutt via havet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        .leaflet-container { cursor: crosshair; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([57.7, 11.95], 9);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenSeaMap',
            opacity: 0.7
        }).addTo(map);

        const landPolygons = [];

        // Startpunkt (på havet)
        const start = L.latLng(57.65, 11.8);
        L.marker(start).addTo(map).bindPopup("Startposition").openPopup();

        let routeLine = null;
        let goalMarker = null;

        function isInLand(latlng) {
            return landPolygons.some(polygon => polygon.getBounds().contains(latlng));
        }

        function findNearestCoast(goal) {
            let step = 0.002;
            let current = L.latLng(goal.lat, goal.lng);
            while (isInLand(current) && current.lat > 57.6) {
                current = L.latLng(current.lat - step, current.lng);
            }
            return current;
        }

        function avoidObstacle(from, to) {
            const waypoints = [from];
            const midLat = (from.lat + to.lat) / 2;
            const midLng = (from.lng + to.lng) / 2;
            const midpoint = L.latLng(midLat, midLng);

            if (isInLand(midpoint)) {
                waypoints.push(L.latLng(midLat, midLng + 0.05));
            }

            waypoints.push(to);
            return waypoints;
        }

        map.on('click', function (e) {
            if (drawMode) {
                drawnPolygon.push(e.latlng);
                if (drawLayer) map.removeLayer(drawLayer);
                drawLayer = L.polygon(drawnPolygon, { color: 'green', fillOpacity: 0.4 }).addTo(map);
                return;
            }

            if (goalMarker) map.removeLayer(goalMarker);
            if (routeLine) map.removeLayer(routeLine);

            const goal = e.latlng;
            goalMarker = L.marker(goal).addTo(map).bindPopup("Din destination").openPopup();

            const coast = findNearestCoast(goal);
            L.marker(coast).addTo(map).bindPopup("Närmaste havspunkt");

            const route = avoidObstacle(start, coast);

            routeLine = L.polyline(route, { color: 'blue', weight: 4 }).addTo(map);
        });

        // Rita polygonläge
        let drawMode = false;
        let drawnPolygon = [];
        let drawLayer = null;

        const toggleButton = L.control({ position: 'topright' });
        toggleButton.onAdd = function () {
            const button = L.DomUtil.create('button', 'leaflet-bar');
            button.innerHTML = drawMode ? 'Avsluta' : 'Lägg till land';
            button.style.background = 'white';
            button.style.padding = '5px';
            button.style.cursor = 'pointer';

            button.onclick = function () {
                drawMode = !drawMode;
                button.innerHTML = drawMode ? 'Avsluta' : 'Lägg till land';
                if (!drawMode && drawnPolygon.length > 2) {
                    const polygon = L.polygon(drawnPolygon, { color: 'green', fillOpacity: 0.4 }).addTo(map);
                    landPolygons.push(polygon);
                    drawnPolygon = [];
                    if (drawLayer) map.removeLayer(drawLayer);
                }
            };
            return button;
        };
        toggleButton.addTo(map);
    </script>
</body>
</html>
