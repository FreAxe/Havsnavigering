<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>BÃ¥trutt via havet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        .leaflet-container { cursor: crosshair; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-path-drag"></script>
    <script>
        const map = L.map('map').setView([57.7, 11.95], 9);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenSeaMap',
            opacity: 0.7
        }).addTo(map);

        const landPolygons = [];

        const start = L.latLng(57.65, 11.8);
        L.marker(start).addTo(map).bindPopup("Startposition").openPopup();

        let routeLine = null;
        let goalMarker = null;

        function isInLand(latlng) {
            return landPolygons.some(polygon => polygon.getBounds().contains(latlng));
        }

        function findNearestCoast(goal) {
            let step = 0.002;
            let current = L.latLng(goal.lat, goal.lng);
            while (isInLand(current) && current.lat > 57.6) {
                current = L.latLng(current.lat - step, current.lng);
            }
            return current;
        }

        function avoidObstacle(from, to) {
            const waypoints = [from];
            const midLat = (from.lat + to.lat) / 2;
            const midLng = (from.lng + to.lng) / 2;
            const midpoint = L.latLng(midLat, midLng);

            if (isInLand(midpoint)) {
                waypoints.push(L.latLng(midLat, midLng + 0.05));
            }

            waypoints.push(to);
            return waypoints;
        }

        map.on('click', function (e) {
            if (drawMode) {
                drawnPolygon.push(e.latlng);
                if (drawLayer) map.removeLayer(drawLayer);
                drawLayer = L.polygon(drawnPolygon, { color: 'green', fillOpacity: 0.4 }).addTo(map);
                return;
            }
            if (fillMode) {
                const radius = 0.05;
                const bounds = [
                    [e.latlng.lat - radius, e.latlng.lng - radius],
                    [e.latlng.lat + radius, e.latlng.lng + radius]
                ];
                const fillPoly = L.rectangle(bounds, {
                    color: 'green', fillOpacity: 0.4,
                    draggable: true
                }).addTo(map);
                landPolygons.push(fillPoly);
                return;
            }

            if (!drawMode && !fillMode) {
                if (goalMarker) map.removeLayer(goalMarker);
                if (routeLine) map.removeLayer(routeLine);

                const goal = e.latlng;
                goalMarker = L.marker(goal).addTo(map).bindPopup("Din destination").openPopup();

                const coast = findNearestCoast(goal);
                L.marker(coast).addTo(map).bindPopup("NÃ¤rmaste havspunkt");

                const route = avoidObstacle(start, coast);

                routeLine = L.polyline(route, { color: 'blue', weight: 4 }).addTo(map);
            }
        });

        // Rita polygonlÃ¤ge
        let drawMode = false;
        let fillMode = false;
        let drawnPolygon = [];
        let drawLayer = null;

        const toggleButton = L.control({ position: 'topright' });
        toggleButton.onAdd = function () {
            const container = L.DomUtil.create('div');

            const landBtn = L.DomUtil.create('button', '', container);
            landBtn.innerHTML = 'LÃ¤gg till land';
            landBtn.style.background = 'white';
            landBtn.style.padding = '5px';
            landBtn.style.cursor = 'pointer';

            const fillBtn = L.DomUtil.create('button', '', container);
            fillBtn.innerHTML = 'ðŸª£ Markera landyta';
            fillBtn.style.background = 'white';
            fillBtn.style.padding = '5px';
            fillBtn.style.cursor = 'pointer';
            fillBtn.style.marginTop = '5px';

            landBtn.onclick = function () {
                drawMode = !drawMode;
                fillMode = false;
                landBtn.innerHTML = drawMode ? 'Avsluta' : 'LÃ¤gg till land';
                if (!drawMode && drawnPolygon.length > 2) {
                    const polygon = L.polygon(drawnPolygon, { color: 'green', fillOpacity: 0.4, draggable: true }).addTo(map);
                    landPolygons.push(polygon);
                    drawnPolygon = [];
                    if (drawLayer) map.removeLayer(drawLayer);
                }
            };

            fillBtn.onclick = function () {
                fillMode = !fillMode;
                drawMode = false;
                landBtn.innerHTML = 'LÃ¤gg till land';
            };

            return container;
        };
        toggleButton.addTo(map);
    </script>
</body>
</html>
